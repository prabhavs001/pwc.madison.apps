#<VirtualHost *:80>
#	ServerName pwc-inform-origin-extpub-qa2.pwc.com
#	RedirectMatch 301 (.*) https://madison-qa2.pwc.com
#</VirtualHost>


<VirtualHost *:80>
        DocumentRoot /var/www/html/
	ServerName madison-qa2.pwc.com
	ServerAlias ums-madison-qa2.pwc.com
	#Redirect / https://madison-qa2.pwc.com
        
	RewriteEngine On
	SSLProxyEngine on
        ProxyPassInterpolateEnv On
	
	##Global rewrite include
	Include /etc/httpd/conf.d/rewrites/base_rewrite.rules
	
	##Search proxy rewrite include - This should be before URL Shortening.
 	Include /etc/httpd/conf.d/rewrites/search_proxy_rewrite.rules
	
	##Global rewrite include - UMS
	Include /etc/httpd/conf.d/rewrites/ums_madison_rewrite.rules
	
	##Global rewrite include - PWC
	Include /etc/httpd/conf.d/rewrites/pwc_madison_rewrite.rules

       # Changing S&P Recent Query Cookie in case of SAYT / Autocomplete call (NEW Change for DROP 3)
	RewriteCond %{QUERY_STRING} view=SAYT
	RewriteRule .* - [E=sayt:true]
	<IfModule mod_headers.c>
	Header unset Set-Cookie env=sayt
	</IfModule>

	AllowEncodedSlashes On
        <LocationMatch "/search/query/">
            RequestHeader set Authorization "Basic ZGNoYXVoYW5AYWRvYmUuY29tOmRpdnlhbnRpMDQ="
        </LocationMatch>
        #RewriteRule ^/search/query/(.*)$ http://stage-sp10051001.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - US
	RewriteRule ^/search/query/us/en/(.*)$  https://stage-sp10051001.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - AU
	RewriteRule ^/search/query/au/en/(.*)$  https://stage-sp1004f9d9.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - UK
	RewriteRule ^/search/query/uk/en/(.*)$  https://stage-sp10056c2a.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - CA, EN
	RewriteRule ^/search/query/ca/en/(.*)$  https://stage-sp10056c2e.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - CA, FR
	RewriteRule ^/search/query/ca/fr/(.*)$  https://stage-sp10056c2c.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - IE
	RewriteRule ^/search/query/ie/en/(.*)$  https://stage-sp10056c28.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - EU
	RewriteRule ^/search/query/eu/en/(.*)$  https://stage-sp10056c26.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - JP
	RewriteRule ^/search/query/jp/ja/(.*)$  https://stage-sp1004f9da.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - es
	RewriteRule ^/search/query/es/es/(.*)$  https://stage-sp1004f9dc.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - gx
	RewriteRule ^/search/query/gx/en/(.*)$  https://stage-sp10056c27.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - CN,EN
	RewriteRule ^/search/query/cn/en/(.*)$  https://stage-sp10056c2b.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - CN,zh
	RewriteRule ^/search/query/cn/zh/(.*)$  https://stage-sp10056c2b.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - NL,en
	RewriteRule ^/search/query/nl/en/(.*)$  https://stage-sp1004f9db.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - NL,nl
	RewriteRule ^/search/query/nl/nl/(.*)$  https://stage-sp1004f9db.guided.ss-omtrdc.net$1 [P,L]
	# Redirect to actual S&P end point - Default to US
	RewriteRule ^/search/query/(.*)$  https://stage-sp10051001.guided.ss-omtrdc.net$1 [P,L]
        
        # Changing S&P Recent Query Cookie to read it from host domain
	RewriteCond %{REQUEST_URI} ^/search/query/(.*)$
	RewriteRule .* - [E=host:%{SERVER_NAME}]
	ProxyPassReverseCookieDomain ".guided.ss-omtrdc.net" ${host} interpolate

        <Directory /var/www/html/>


           <IfModule mod_deflate.c>

           # Enable gzip compression
           SetOutputFilter DEFLATE

           # Don't compress binaries
           SetEnvIfNoCase Request_URI .(?:exe|t?gz|zip|iso|tar|bz2|sit|rar) no-gzip dont-vary

           # Don't compress images
           SetEnvIfNoCase Request_URI .(?:gif|jpe?g|jpg|ico|png)  no-gzip dont-vary

           # Don't compress PDFs
           SetEnvIfNoCase Request_URI .pdf no-gzip dont-vary

           # Don't compress flash files
           SetEnvIfNoCase Request_URI .flv no-gzip dont-vary

           # Netscape 4.X has some problems
           BrowserMatch ^Mozilla/4 gzip-only-text/html

           # Netscape 4.06-4.08 have some more problems
           BrowserMatch ^Mozilla/4.0[678] no-gzip

           # MSIE masquerades as Netscape, but it is fine
           BrowserMatch \bMSIE !no-gzip !gzip-only-text/html

           # Make sure proxies don't deliver the wrong content
           Header append Vary User-Agent env=!dont-vary

           </IfModule>


                <IfModule disp_apache2.c>
                        SetHandler dispatcher-handler
                        ModMimeUsePathInfo On

                        DirectorySlash Off
                </IfModule>

	       AddOutputFilter INCLUDES .html

                Options FollowSymLinks Includes
                AllowOverride None
        </Directory>

#========================Madison UMS site rules================================
#Redirect rule to redirect Long html URLs to short URL
RewriteCond %{REQUEST_URI} ^(.*)(\.html)$ [NC]
RewriteCond %{HTTP_HOST} ^ums-madison-qa2\.pwc\.com$ [NC]
RewriteRule ^(/content/madison-ums/)(.*) "/$2" [L,R=301]

#Redirect Long DAM URLs to short URLs
RewriteCond %{HTTP_HOST} ^ums-madison-qa2\.pwc\.com$ [NC]
RewriteRule ^(/content/dam/madison-ums/)(.*) "/$2" [L,R=301]

#Rewrite the HTML page short path to long paths. Long paths will the be processed by the dispatcher module
RewriteCond %{REQUEST_URI} !^/apps
RewriteCond %{REQUEST_URI} !^/content
RewriteCond %{REQUEST_URI} !^/etc
RewriteCond %{REQUEST_URI} !^/libs
RewriteCond %{REQUEST_URI} !^/bin
RewriteCond %{REQUEST_URI} !^/tmp
RewriteCond %{REQUEST_URI} !^/var
RewriteCond %{HTTP_HOST} ^ums-madison-qa2\.pwc\.com$ [NC]
RewriteCond %{REQUEST_URI} ^/(.*)(\.html)$ 
RewriteRule ^(/.*)$ /content/madison-ums$1 [PT,L]

#Rewrite the UMS DAM short path to long paths. Long paths will then be processed by the dispatcher module
RewriteCond %{REQUEST_URI} !^/apps
RewriteCond %{REQUEST_URI} !^/content
RewriteCond %{REQUEST_URI} !^/etc
RewriteCond %{REQUEST_URI} !^/libs
RewriteCond %{REQUEST_URI} !^/bin
RewriteCond %{REQUEST_URI} !^/tmp
RewriteCond %{REQUEST_URI} !^/var
RewriteCond %{REQUEST_URI} !^/crx
RewriteCond %{REQUEST_URI} (.*)\.[a-zA-Z0-9-]+$
RewriteCond %{REQUEST_URI} !.*\.(json|jsp)
RewriteCond %{HTTP_HOST} ^ums-madison-qa2\.pwc\.com$ [NC]
RewriteRule ^(/.*)$ /content/dam/madison-ums$1 [PT,L]

#========================Madison External site rules============================ 
#Redirect rule to redirect Long ditaroot html URLs to short URL dt
RewriteCond %{REQUEST_URI} ^(.*)(\.html)$ [NC]
RewriteCond %{HTTP_HOST} ^madison-qa2\.pwc\.com$ [NC]
RewriteRule ^(/content/pwc-madison/ditaroot/)(.*) "/dt/$2" [L,R=301]

#Redirect rule to redirect Long html URLs to short URL
RewriteCond %{REQUEST_URI} ^(.*)(\.html)$ [NC]
RewriteCond %{HTTP_HOST} ^madison-qa2\.pwc\.com$ [NC]
RewriteRule ^(/content/pwc-madison/)(.*) "/$2" [L,R=301]

#Redirect ditaroot Long DAM URLs to short URLs
RewriteCond %{HTTP_HOST} ^madison-qa2\.pwc\.com$ [NC]
RewriteRule ^(/content/dam/pwc-madison/ditaroot/)(.*) "/dt/$2" [L,R=301]

#Redirect Long DAM URLs to short URLs
RewriteCond %{HTTP_HOST} ^madison-qa2\.pwc\.com$ [NC]
RewriteRule ^(/content/dam/pwc-madison/)(.*) "/$2" [L,R=301]


# Rewrite dt path to long ditaroot paths. Long paths will the be processed by the dispatcher module
RewriteCond %{REQUEST_URI} !^/apps
RewriteCond %{REQUEST_URI} !^/content
RewriteCond %{REQUEST_URI} !^/etc
RewriteCond %{REQUEST_URI} !^/libs
RewriteCond %{REQUEST_URI} !^/bin
RewriteCond %{REQUEST_URI} !^/tmp
RewriteCond %{REQUEST_URI} !^/var
RewriteCond %{HTTP_HOST} ^madison-qa2\.pwc\.com$ [NC]
RewriteCond %{REQUEST_URI} ^/dt/(.*)(\.html)$ 
RewriteRule ^/dt/(.*)$ /content/pwc-madison/ditaroot/$1 [PT,L]

#Rewrite the path to long html paths. Long paths will then be processed by the dispatcher module.
RewriteCond %{REQUEST_URI} !^/apps
RewriteCond %{REQUEST_URI} !^/content
RewriteCond %{REQUEST_URI} !^/etc
RewriteCond %{REQUEST_URI} !^/libs
RewriteCond %{REQUEST_URI} !^/bin
RewriteCond %{REQUEST_URI} !^/tmp
RewriteCond %{REQUEST_URI} !^/var
RewriteCond %{HTTP_HOST} ^madison-qa2\.pwc\.com$ [NC]
RewriteCond %{REQUEST_URI} ^/(.*)(\.(html|html/))$ 
RewriteRule ^(/.*)$ /content/pwc-madison$1 [PT,L]

#Rewrite the Madison DAM short path to long paths. Long paths will then be processed by the dispatcher module
RewriteCond %{REQUEST_URI} !^/apps
RewriteCond %{REQUEST_URI} !^/content
RewriteCond %{REQUEST_URI} !^/etc
RewriteCond %{REQUEST_URI} !^/libs
RewriteCond %{REQUEST_URI} !^/bin
RewriteCond %{REQUEST_URI} !^/tmp
RewriteCond %{REQUEST_URI} !^/var
RewriteCond %{REQUEST_URI} !^/crx
RewriteCond %{REQUEST_URI} (.*)\.[a-zA-Z0-9-]+$
RewriteCond %{REQUEST_URI} !.*\.(json|jsp|css|js)
RewriteCond %{HTTP_HOST} ^madison-qa2\.pwc\.com$ [NC]
RewriteRule ^/dt/(.*)$ /content/dam/pwc-madison/ditaroot/$1 [PT,L]

#Rewrite the Madison DAM short path to long paths. Long paths will then be processed by the dispatcher module
RewriteCond %{REQUEST_URI} !^/apps
RewriteCond %{REQUEST_URI} !^/content
RewriteCond %{REQUEST_URI} !^/etc
RewriteCond %{REQUEST_URI} !^/libs
RewriteCond %{REQUEST_URI} !^/bin
RewriteCond %{REQUEST_URI} !^/tmp
RewriteCond %{REQUEST_URI} !^/var
RewriteCond %{REQUEST_URI} !^/crx
RewriteCond %{REQUEST_URI} (.*)\.[a-zA-Z0-9-]+$
RewriteCond %{REQUEST_URI} !.*\.(json|jsp|css|js)
RewriteCond %{HTTP_HOST} ^madison-qa2\.pwc\.com$ [NC]
RewriteRule ^(/.*)$ /content/dam/pwc-madison$1 [PT,L]

</VirtualHost>

